{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "omsLogAnalyticsWorkspaceName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Create new or refer to an existing OMS Log Analytics Workspace"
            }
        }
    },
    "variables": {
        "solutionname": "Kemp Application Delivery",
        "omsLogAnalyticsAPIVersion": "2015-11-01-preview",
        "solutionpublisher": "QND",
        "solutionversion": "1",
        "solutionauthor": "Daniele Grandini",
        "solutiondescription": "Kemp Application Delivery Solution",
        "querytemplateuri": "https//rawcontent.github.com",
        "location": "[resourceGroup().location]",
        "deploymentsApiVersion": "2015-01-01",
        "savedSearchesCategory": "Kemp Application Delivery by QND"
    },
    "resources": [
        {
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "name": "[parameters('omslogAnalyticsWorkspaceName')]",
            "type": "Microsoft.OperationalInsights/workspaces",
            "location": "[variables('location')]"
        },
// 1 - Alert on device license expiring          
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ2')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]"
            ],
            "properties": {
                "category": "[variables('savedSearchesCategory')]",
                "ETag": "*",
                "DisplayName": "Alert - Device Expiring",
                "Query": "Type:KempDevice_CL LicensedUntil_t < NOW+2MONTH | dedup Computer",
                "Version": "1"
            }
        },
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ2', '/', 'QA2Schedule')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]", /* need to add explicit dependency */
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ2')]"
            ],
            "properties": {
                "ETag": "*", // required to proper removal
                "Interval": 60,
                "QueryTimeSpan": 60,
                "Enabled": true,
                "NearRealTime": false
            }
        },
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ2', '/', 'QA2Schedule','/','A1')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]", /* need to add explicit dependency */
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules', parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ2', 'QA2Schedule')]"
            ],
            "properties": {
                "ETag": "*", // required to proper removal            
                "Type": "Alert",
                "Name": "KEMP - Device license is about to expire",
                "Description": "The license for the device is about to expire, renew the license or your device will stop working",
                "Threshold": {
                    "Operator": "gt",
                    "Value": 0
                },
                "Severity": "critical", //warning, informational
                "ScheduleType": "Normal",
                "ScheduleTypeSpecified": true,
                "Version": 1
            }
        },
// 2 - Alert on VS not Up                 
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ1')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]"
            ],
            "properties": {
                "category": "[variables('savedSearchesCategory')]",
                "ETag": "*",
                "query": "Type:KempStatus_CL (servertype_s=vs OR servertype_s=subvs) enabled_s=Y  status_s != Up | measure count() by Computer, name_s interval 10minutes",
                "displayName": "Alert - Virtual Server (VS) not operational"
            }
        },
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ1', '/', 'QA1Schedule')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]", /* need to add explicit dependency */
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ1')]"
            ],
            "properties": {
                "ETag": "*", // required to proper removal
                "Interval": 5,
                "QueryTimeSpan": 15,
                //"Active": "true",
                "Enabled": true,
                "NearRealTime": false
            }
        },
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ1', '/', 'QA1Schedule','/','A1')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]", /* need to add explicit dependency */
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules', parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ1', 'QA1Schedule')]"
            ],
            "properties": {
                "ETag": "*", // required to proper removal            
                "Type": "Alert",
                "Name": "KEMP - Virtual Server (VS) not operational",
                "Description": "The VS status is not Up this means the service provided byt this VS is not available",
                "Threshold": {
                    "Operator": "gt",
                    "Value": 0,
                    "MetricsTrigger": {
                        "TriggerCondition": "Total",
                        "Operator": "gt",
                        "Value": 0
                    }
                },
                "Severity": "critical", //warning, informational
                "ScheduleType": "Normal",
                "ScheduleTypeSpecified": true,
                "Version": 1
            }
        },
// 3 - Alert on TPS approaching 200                 
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ3')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]"
            ],
            "properties": {
                "category": "[variables('savedSearchesCategory')]",
                "ETag": "*",
                "query": "Type:Perf ObjectName=KempLM-TPS CounterName=\"Total TPS\" | measure max(CounterValue) by Computer interval 15MINUTE",
                "displayName": "Alert - TPS approaching device limit"
            }
        },
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ3', '/', 'QA3Schedule')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]", /* need to add explicit dependency */
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ3')]"
            ],
            "properties": {
                "ETag": "*", // required to proper removal
                "Interval": 15,
                "QueryTimeSpan": 60,
                //"Active": "true",
                "Enabled": false,
                "NearRealTime": false
            }
        },
        {
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/', 'QNDKempAlertQ3', '/', 'QA3Schedule','/','A1')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]", /* need to add explicit dependency */
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules', parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ3', 'QA3Schedule')]"
            ],
            "properties": {
                "ETag": "*", // required to proper removal            
                "Type": "Alert",
                "Name": "KEMP - TPS approaching the device capcity",
                "Description": "The current load in TPS is approaching the device limit. Take action to avoid service disruption",
                "Threshold": {
                    "Operator": "gt",
                    "Value": 0,
                    "MetricsTrigger": {
                        "TriggerCondition": "Total",
                        "Operator": "gt",
                        "Value": 190
                    }
                },
                "Severity": "critical", //warning, informational
                "ScheduleType": "Normal",
                "ScheduleTypeSpecified": true,
                "Version": 1
            }
        },        
// View get from the Views Designer, copy and paste the "Dashboard" and "OverviewTile" sections
        {
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "name": "[concat(parameters('omsLogAnalyticsWorkspaceName'), '/' ,variables('solutionname'))]",
            "type": "Microsoft.OperationalInsights/workspaces/views",
            "location": "[resourceGroup().location]",
            "id": "[Concat(subscription().id, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'), '/views/', variables('solutionname'))]",
            "dependson": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]"
            ],
            "properties": {
                "Id": "[variables('solutionname')]",
                "Name": "[variables('solutionname')]",
                "displayName": "[variables('solutionname')]",
                "Description": "[variables('solutiondescription')]",
                "Author": "[variables('solutionauthor')]",
                "Source": "Local",
                "Dashboard": [
                    {
                        "Id": "InformationBlade",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "Title": "",
                                "NewGroup": false,
                                "Color": "#0072c6"
                            },
                            "Header": {
                                "Image": "",
                                "Label": "Kemp Application Delivery monitoring",
                                "Link": {
                                    "Label": "More info",
                                    "Url": "https://github.com/QuaeNocentDocent/omskemp"
                                }
                            },
                            "List": [
                                {
                                    "Title": "The solution needs to be configured",
                                    "Content": "## OMS agent configuration\n\nOn a supported Linux platform install the [OMS agent](https://github.com/Microsoft/OMS-Agent-for-Linux)\n\nInstall the Kemp extension following these [steps](https://github.com/QuaeNocentDocent/OMS-Agent-for-Linux)\n\n## Kemp device configuration\n\n1. Enable the REST API\n2. Create a readonly user\n3. Optionally configure an external syslog server pointing to the linux system where you installed the extension using udp on port 25326\n\n## Configure the solution\nEdit the /etc/opt/microsoft/omsagent/conf/omsagent.d/kemp.conf file to add the devices you want to poll and the credentials. [More info](https://github.com/QuaeNocentDocent/OMS-Agent-for-Linux)\n\n![Kemp Logo](\"https://kemptechnologies.com/sites/all/themes/custom/ktwide/images/KEMP-logov2.svg\")"
                                }
                            ]
                        }
                    },
                    {
                        "Id": "SingleQueryDonutBuilderBladeV1",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "title": "Connected Devices",
                                "newGroup": false,
                                "icon": "",
                                "useIcon": false
                            },
                            "Header": {
                                "Title": "Devices by model",
                                "Subtitle": ""
                            },
                            "Donut": {
                                "Query": "Type:KempDevice_CL | measure countdistinct(Computer) by ApplianceModel_s",
                                "CenterLegend": {
                                    "Text": "Total",
                                    "Operation": "Sum",
                                    "ArcsToSelect": []
                                },
                                "Options": {
                                    "colors": [
                                        "#00188f",
                                        "#0072c6",
                                        "#00bcf2"
                                    ],
                                    "valueColorMapping": []
                                }
                            },
                            "List": {
                                "Query": "Type:KempDevice_CL | measure countdistinct(Computer) by Computer,ApplianceModel_s",
                                "HideGraph": true,
                                "enableSparklines": false,
                                "operation": "Summary",
                                "ColumnsTitle": {
                                    "Name": "Computer",
                                    "Value": "Count"
                                },
                                "Color": "#0072c6",
                                "thresholds": {
                                    "isEnabled": false,
                                    "values": [
                                        {
                                            "name": "Normal",
                                            "threshold": "Default",
                                            "color": "#009e49",
                                            "isDefault": true
                                        },
                                        {
                                            "name": "Warning",
                                            "threshold": "60",
                                            "color": "#fcd116",
                                            "isDefault": false
                                        },
                                        {
                                            "name": "Error",
                                            "threshold": "90",
                                            "color": "#ba141a",
                                            "isDefault": false
                                        }
                                    ]
                                },
                                "NameDSVSeparator": "",
                                "NavigationQuery": "{selected item} Type:KempDevice_CL"
                            }
                        }
                    },
                    {
                        "Id": "SingleQueryDonutBuilderBladeV1",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "title": "",
                                "newGroup": false,
                                "icon": "",
                                "useIcon": false
                            },
                            "Header": {
                                "Title": "Devices by version",
                                "Subtitle": ""
                            },
                            "Donut": {
                                "Query": "Type:KempDevice_CL | measure countdistinct(Computer) by version_s",
                                "CenterLegend": {
                                    "Text": "Total",
                                    "Operation": "Sum",
                                    "ArcsToSelect": []
                                },
                                "Options": {
                                    "colors": [
                                        "#00188f",
                                        "#0072c6",
                                        "#00bcf2"
                                    ],
                                    "valueColorMapping": []
                                }
                            },
                            "List": {
                                "Query": "Type:KempDevice_CL | measure countdistinct(Computer) by Computer, version_s",
                                "HideGraph": false,
                                "enableSparklines": false,
                                "operation": "Summary",
                                "ColumnsTitle": {
                                    "Name": "Computer",
                                    "Value": "Count"
                                },
                                "Color": "#0072c6",
                                "thresholds": {
                                    "isEnabled": false,
                                    "values": [
                                        {
                                            "name": "Normal",
                                            "threshold": "Default",
                                            "color": "#009e49",
                                            "isDefault": true
                                        },
                                        {
                                            "name": "Warning",
                                            "threshold": "60",
                                            "color": "#fcd116",
                                            "isDefault": false
                                        },
                                        {
                                            "name": "Error",
                                            "threshold": "90",
                                            "color": "#ba141a",
                                            "isDefault": false
                                        }
                                    ]
                                },
                                "NameDSVSeparator": "",
                                "NavigationQuery": "{selected item} Type:KempDevice_CL"
                            }
                        }
                    },
                    {
                        "Id": "NumberTileListBuilderBlade",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "title": "",
                                "newGroup": false,
                                "icon": "",
                                "useIcon": false
                            },
                            "Tile": {
                                "Query": "Type:KempDevice_CL | measure count() by Computer",
                                "Legend": "Devices by license expiration"
                            },
                            "List": {
                                "Query": "Type:KempDevice_CL | measure max(LicensedUntil_t) As Expiration by Computer, LicensedUntil_t | sort Expiration",
                                "HideGraph": true,
                                "enableSparklines": false,
                                "operation": "Summary",
                                "ColumnsTitle": {
                                    "Name": "Device",
                                    "Value": ""
                                },
                                "Color": "#0072c6",
                                "thresholds": {
                                    "isEnabled": false,
                                    "values": [
                                        {
                                            "name": "Normal",
                                            "threshold": "Default",
                                            "color": "#009e49",
                                            "isDefault": true
                                        },
                                        {
                                            "name": "Warning",
                                            "threshold": "60",
                                            "color": "#fcd116",
                                            "isDefault": false
                                        },
                                        {
                                            "name": "Error",
                                            "threshold": "90",
                                            "color": "#ba141a",
                                            "isDefault": false
                                        }
                                    ]
                                },
                                "NameDSVSeparator": "",
                                "NavigationQuery": "{selected item} Type:KempDevice_CL"
                            }
                        }
                    },
                    {
                        "Id": "LineChartBuilderBlade",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "title": "Device usage",
                                "newGroup": true,
                                "icon": "",
                                "useIcon": false
                            },
                            "Header": {
                                "Title": "TPS Usage over time",
                                "Subtitle": ""
                            },
                            "LineChart": {
                                "Query": "Type:Perf (ObjectName=\"KempLM-TPS\") CounterName=\"Total TPS\" | measure max(CounterValue) by Computer | display linechart",
                                "yAxis": {
                                    "isLogarithmic": false,
                                    "units": {
                                        "baseUnitType": "",
                                        "baseUnit": "",
                                        "displayUnit": ""
                                    },
                                    "customLabel": ""
                                }
                            },
                            "List": {
                                "Query": "Type:Perf (ObjectName=\"KempLM-TPS\") CounterName=\"Total TPS\" | measure percentile99(CounterValue) by Computer",
                                "HideGraph": false,
                                "enableSparklines": true,
                                "operation": "Summary",
                                "ColumnsTitle": {
                                    "Name": "Device",
                                    "Value": "TPS"
                                },
                                "Color": "#0072c6",
                                "thresholds": {
                                    "isEnabled": false,
                                    "values": [
                                        {
                                            "name": "Normal",
                                            "threshold": "Default",
                                            "color": "#009e49",
                                            "isDefault": true
                                        },
                                        {
                                            "name": "Warning",
                                            "threshold": "150",
                                            "color": "#fcd116",
                                            "isDefault": false
                                        },
                                        {
                                            "name": "Error",
                                            "threshold": "190",
                                            "color": "#ba141a",
                                            "isDefault": false
                                        }
                                    ]
                                },
                                "NameDSVSeparator": "",
                                "NavigationQuery": "{selected item} Type:Perf (ObjectName=\"KempLM-TPS\") CounterName=\"Total TPS\""
                            }
                        }
                    },
                    {
                        "Id": "LineChartBuilderBlade",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "title": "",
                                "newGroup": false,
                                "icon": "",
                                "useIcon": false
                            },
                            "Header": {
                                "Title": "CPU Usage over time",
                                "Subtitle": ""
                            },
                            "LineChart": {
                                "Query": "Type:Perf (ObjectName=\"KempLM-Processor\") (CounterName=\"% Total Time\") | measure percentile95(CounterValue) by Computer interval 15MINUTES | display linechart",
                                "yAxis": {
                                    "isLogarithmic": false,
                                    "units": {
                                        "baseUnitType": "",
                                        "baseUnit": "",
                                        "displayUnit": ""
                                    },
                                    "customLabel": ""
                                }
                            },
                            "List": {
                                "Query": "Type:Perf (ObjectName=\"KempLM-Processor\") (CounterName=\"% Total Time\") | measure percentile95(CounterValue) by Computer interval 15MINUTES",
                                "HideGraph": false,
                                "enableSparklines": true,
                                "operation": "Summary",
                                "ColumnsTitle": {
                                    "Name": "Device",
                                    "Value": "% CPU"
                                },
                                "Color": "#0072c6",
                                "thresholds": {
                                    "isEnabled": true,
                                    "values": [
                                        {
                                            "name": "Normal",
                                            "threshold": "Default",
                                            "color": "#009e49",
                                            "isDefault": true
                                        },
                                        {
                                            "name": "Warning",
                                            "threshold": "60",
                                            "color": "#fcd116",
                                            "isDefault": false
                                        },
                                        {
                                            "name": "Error",
                                            "threshold": "90",
                                            "color": "#ba141a",
                                            "isDefault": false
                                        }
                                    ]
                                },
                                "NameDSVSeparator": "",
                                "NavigationQuery": "{selected item} Type:Perf (ObjectName=\"KempLM-Processor\") (CounterName=\"% System Time\") | measure percentile95(CounterValue) by Computer interval 15MINUTES | display linechart"
                            }
                        }
                    },
                    {
                        "Id": "LineChartBuilderBlade",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "title": "",
                                "newGroup": false,
                                "icon": "",
                                "useIcon": false
                            },
                            "Header": {
                                "Title": "Memory used over time",
                                "Subtitle": ""
                            },
                            "LineChart": {
                                "Query": "Type:Perf (ObjectName=\"KempLM-Memory\") CounterName=\"% Used\" | measure percentile99(CounterValue) by Computer | display linechart",
                                "yAxis": {
                                    "isLogarithmic": false,
                                    "units": {
                                        "baseUnitType": "",
                                        "baseUnit": "",
                                        "displayUnit": ""
                                    },
                                    "customLabel": ""
                                }
                            },
                            "List": {
                                "Query": "Type:Perf (ObjectName=\"KempLM-Memory\") CounterName=\"% Used\" | measure percentile99(CounterValue) As MemoryUsed by Computer | sort MemoryUsed desc",
                                "HideGraph": false,
                                "enableSparklines": true,
                                "operation": "Summary",
                                "ColumnsTitle": {
                                    "Name": "Device",
                                    "Value": "% Used"
                                },
                                "Color": "#0072c6",
                                "thresholds": {
                                    "isEnabled": true,
                                    "values": [
                                        {
                                            "name": "Normal",
                                            "threshold": "Default",
                                            "color": "#009e49",
                                            "isDefault": true
                                        },
                                        {
                                            "name": "Warning",
                                            "threshold": "70",
                                            "color": "#fcd116",
                                            "isDefault": false
                                        },
                                        {
                                            "name": "Error",
                                            "threshold": "90",
                                            "color": "#ba141a",
                                            "isDefault": false
                                        }
                                    ]
                                },
                                "NameDSVSeparator": "",
                                "NavigationQuery": "{selected item} Type:Perf (ObjectName=\"KempLM-Memory\") CounterName=\"% Used\" | measure percentile99(CounterValue) As MemoryUsed by Computer | sort MemoryUsed desc"
                            }
                        }
                    },
                    {
                        "Id": "LineChartBuilderBlade",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "title": "VS Status",
                                "newGroup": true,
                                "icon": "",
                                "useIcon": false
                            },
                            "Header": {
                                "Title": "Active connections per VS",
                                "Subtitle": ""
                            },
                            "LineChart": {
                                "Query": "Type:Perf ObjectName=KempLM-VS (CounterName=\"Active Connections\") | measure percentile99(CounterValue) by InstanceName",
                                "yAxis": {
                                    "isLogarithmic": false,
                                    "units": {
                                        "baseUnitType": "",
                                        "baseUnit": "",
                                        "displayUnit": ""
                                    },
                                    "customLabel": ""
                                }
                            },
                            "List": {
                                "Query": "Type:Perf ObjectName=KempLM-VS (CounterName=\"Active Connections\") | measure percentile99(CounterValue) by InstanceName",
                                "HideGraph": false,
                                "enableSparklines": true,
                                "operation": "Summary",
                                "ColumnsTitle": {
                                    "Name": "VS",
                                    "Value": "Active Connections"
                                },
                                "Color": "#0072c6",
                                "thresholds": {
                                    "isEnabled": false,
                                    "values": [
                                        {
                                            "name": "Normal",
                                            "threshold": "Default",
                                            "color": "#009e49",
                                            "isDefault": true
                                        },
                                        {
                                            "name": "Warning",
                                            "threshold": "60",
                                            "color": "#fcd116",
                                            "isDefault": false
                                        },
                                        {
                                            "name": "Error",
                                            "threshold": "90",
                                            "color": "#ba141a",
                                            "isDefault": false
                                        }
                                    ]
                                },
                                "NameDSVSeparator": "",
                                "NavigationQuery": "{selected item} Type:Perf ObjectName=KempLM-VS (CounterName=\"Active Connections\") | measure max(CounterValue) by InstanceName interval 10MINUTES"
                            }
                        }
                    },
                    {
                        "Id": "SingleQueryDonutBuilderBladeV1",
                        "Type": "Blade",
                        "Version": 0,
                        "Configuration": {
                            "General": {
                                "title": "",
                                "newGroup": false,
                                "icon": "",
                                "useIcon": false
                            },
                            "Header": {
                                "Title": "VS Status",
                                "Subtitle": ""
                            },
                            "Donut": {
                                "Query": "Type:KempStatus_CL (servertype_s=vs OR servertype_s=subvs) enabled_s=\"Y\"  TimeGenerated > NOW-7MINUTES | dedup name_s | measure count() by status_s",
                                "CenterLegend": {
                                    "Text": "Total",
                                    "Operation": "Sum",
                                    "ArcsToSelect": []
                                },
                                "Options": {
                                    "colors": [
                                        "#00188f",
                                        "#0072c6",
                                        "#00bcf2"
                                    ],
                                    "valueColorMapping": []
                                }
                            },
                            "List": {
                                "Query": "Type:KempStatus_CL (servertype_s=vs OR servertype_s=subvs) enabled_s=\"Y\"  status_s!=\"Up\" | select name_s, status_s | dedup name_s",
                                "HideGraph": false,
                                "enableSparklines": false,
                                "ColumnsTitle": {
                                    "Name": "VS not Up",
                                    "Value": ""
                                },
                                "Color": "#0072c6",
                                "operation": "Summary",
                                "thresholds": {
                                    "isEnabled": true,
                                    "values": [
                                        {
                                            "name": "Normal",
                                            "threshold": "Default",
                                            "color": "#ba141a",
                                            "isDefault": true
                                        },
                                        {
                                            "name": "Warning",
                                            "threshold": "60",
                                            "color": "#fcd116",
                                            "isDefault": false
                                        },
                                        {
                                            "name": "Error",
                                            "threshold": "90",
                                            "color": "#ba141a",
                                            "isDefault": false
                                        }
                                    ]
                                },
                                "NameDSVSeparator": "",
                                "NavigationQuery": "{selected item} Type:KempStatus_CL (servertype_s=vs OR servertype_s=subvs) enabled_s=\"Y\""
                            }
                        }
                    }
                ],
                "OverviewTile": {
                    "Id": "DoubleNumberBuilderTile",
                    "Type": "OverviewTile",
                    "Version": 0,
                    "Configuration": {
                        "TileOne": {
                            "Legend": "Kemp Devices",
                            "Query": "Type:KempDevice_CL | measure countdistinct(Computer) by Computer"
                        },
                        "TileTwo": {
                            "Legend": "Virtual Servers",
                            "Query": "Type:KempStatus_CL | measure countdistinct(name_s) by name_s"
                        },
                        "Advanced": {
                            "DataFlowVerification": {
                                "Enabled": true,
                                "Query": "Type:KempDevice_CL",
                                "Message": "The solution needs to be configured for data to be gathered"
                            }
                        }
                    }
                }
            }
        },
// Solution definition with all the dependencies needed        
        {
            "type": "Microsoft.OperationsManagement/solutions",
            "name": "[variables('solutionname')]",
            "apiVersion": "[variables('omsLogAnalyticsAPIVersion')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/views', parameters('omsLogAnalyticsWorkspaceName'), variables('solutionname'))]",
                // as per Kris suggestion add dedendencies to the searches, schedules and actions
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ1')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ1', 'QA1Schedule', 'A1')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ1', 'QA1Schedule')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ2')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ2', 'QA2Schedule', 'A1')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ2', 'QA2Schedule')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ3')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ3', 'QA3Schedule', 'A1')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ3', 'QA3Schedule')]"
            ],
            "plan": {
                "name": "[variables('solutionname')]",
                "publisher": "[variables('solutionpublisher')]",
                "promotionCode": "",
                "product": "[concat('OMSGallery/', variables('solutionname'))]",
                "Version": "[variables('solutionversion')]"
            },
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]",
                "containedResources": [
                    // as per Kris suggestion add the searches, schedules and actions as contained resources
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ1')]",
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ1', 'QA1Schedule', 'A1')]",
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ1', 'QA1Schedule')]",
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ2')]",
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ2', 'QA2Schedule','A1')]",
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ2', 'QA2Schedule')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ3')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ3', 'QA3Schedule', 'A1')]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules',parameters('omsLogAnalyticsWorkspaceName'), 'QNDKempAlertQ3', 'QA3Schedule')]"
                    
                ]
            }
        }
    ],
    "outputs": {}
}